<div class="detail-container">
  <div class="card">
    <div class="measure-container" (click)="closeCardMenu()">
      <!-- Back arrow ย้ายออกจาก card -->
      <i class="fas fa-arrow-left back" (click)="goBack()"></i>

      <!-- จุด 3 จุดย้ายออกจาก card -->
      <div class="card-menu" (click)="toggleCardMenu(); $event.stopPropagation()">
        <i class="fas fa-ellipsis-v"></i>
        <div class="menu-dropdown" *ngIf="showCardMenu" (click)="$event.stopPropagation()">
          <div class="menu-item" (click)="goToProfile(); closeCardMenu()">
            <i class="fas fa-user"></i>
            ข้อมูลผู้ใช้
          </div>
          <div class="menu-item" (click)="goToContactAdmin(); closeCardMenu()">
            <i class="fas fa-user-shield"></i>
            แจ้งแอดมิน
          </div>
        </div>
      </div>

      <div class="card" (click)="$event.stopPropagation()">

        <div class="header">
          <div class="user-summary">
            <div class="user-avatar">
              <i class="fas fa-user"></i>
            </div>
            <div class="user-details">
              <h3 class="user-name">{{ userName || 'ไม่ระบุ' }}</h3>
              <p class="user-email">{{ userEmail || 'ไม่ระบุ' }}</p>
            </div>
          </div>
        </div>

        <!-- ข้อมูลสรุปพื้นที่ -->
        <div class="area-summary-section" *ngIf="areaSummary">
          <div class="section-title">
            <i class="fas fa-chart-line"></i>
            สรุปข้อมูลพื้นที่
          </div>

          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">ชื่อพื้นที่:</div>
              <div class="summary-value">{{ areaSummary.areaName }}</div>
            </div>

            <div class="summary-item">
              <div class="summary-label">Areas ID:</div>
              <div class="summary-value">{{ areaSummary.areasid }}</div>
            </div>

            <div class="summary-item">
              <div class="summary-label">จำนวนจุดวัด:</div>
              <div class="summary-value">{{ areaSummary.totalPoints }} จุด</div>
            </div>

            <div class="summary-item">
              <div class="summary-label">ขนาดพื้นที่:</div>
              <div class="summary-value">{{ areaSummary.areaSizeFormatted }}</div>
            </div>

            <div class="summary-item">
              <div class="summary-label">วันที่วัดล่าสุด:</div>
              <div class="summary-value">{{ areaSummary.lastMeasurementDate | date:'dd/MM/yyyy HH:mm' }}</div>
            </div>
          </div>
        </div>

        <!-- ข้อมูลอุปกรณ์และวันที่ -->
        <div class="measurement-info-section">
          <div class="section-title">รายละเอียดการวัด</div>

          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">อุปกรณ์:</span>
              <span class="info-value">{{ deviceId }}</span>
            </div>

            <div class="info-item">
              <span class="info-label">วันที่:</span>
              <span class="info-value">{{ measureDate }}</span>
            </div>

            <div class="info-item">
              <span class="info-label">เวลา:</span>
              <span class="info-value">{{ measureTime }}</span>
            </div>

            <div class="info-item">
              <span class="info-label">Areas ID:</span>
              <span class="info-value">{{ areasid || 'ไม่ระบุ' }}</span>
            </div>

            <div class="info-item full-width">
              <span class="info-label">สถานที่:</span>
              <span class="info-value">{{ getDisplayLocation() }}</span>
            </div>
          </div>
        </div>

        <!-- แผนที่แสดงจุดวัดทั้งหมด -->
        <div class="map-section" *ngIf="measurementPoints.length > 0">
          <div class="section-title">
            <i class="fas fa-map"></i>
            แผนที่แสดงจุดวัดทั้งหมด ({{ measurementPoints.length }} จุด)
          </div>
          <div class="map-container">
            <div #mapContainer class="interactive-map"></div>
          </div>
        </div>

        <!-- ผลการวัดเฉลี่ย -->
        <div class="results-section" *ngIf="areaSummary">
          <div class="section-title">
            <i class="fas fa-calculator"></i>
            ค่าเฉลี่ยการวัดทั้งหมด ({{ areaSummary.totalPoints }} จุด)
          </div>

          <div class="sensors-grid">
            <div class="sensor-card temperature">
              <div class="sensor-icon">
                <img src="https://cdn-icons-png.flaticon.com/512/3534/3534501.png" alt="temperature" />
              </div>
              <div class="sensor-content">
                <div class="sensor-value">{{ formatNumber(areaSummary.averages.temperature) }}</div>
                <div class="sensor-unit">°C</div>
                <div class="sensor-label">อุณหภูมิ</div>
                <div class="sensor-status" [ngClass]="getTemperatureStatus()">
                  {{ getTemperatureStatusText() }}
                </div>
              </div>
            </div>

            <div class="sensor-card moisture">
              <div class="sensor-icon">
                <img src="https://cdn-icons-png.flaticon.com/512/6393/6393411.png" alt="moisture" />
              </div>
              <div class="sensor-content">
                <div class="sensor-value">{{ formatNumber(areaSummary.averages.moisture) }}</div>
                <div class="sensor-unit">%</div>
                <div class="sensor-label">ความชื้น</div>
                <div class="sensor-status" [ngClass]="getMoistureStatus()">
                  {{ getMoistureStatusText() }}
                </div>
              </div>
            </div>

            <div class="sensor-card nitrogen">
              <div class="sensor-icon">
                <img src="https://cdn-icons-png.flaticon.com/512/6678/6678672.png" alt="nitrogen" />
              </div>
              <div class="sensor-content">
                <div class="sensor-value">{{ formatNumber(areaSummary.averages.nitrogen) }}</div>
                <div class="sensor-unit">mg/kg</div>
                <div class="sensor-label">ไนโตรเจน (N)</div>
                <div class="sensor-status" [ngClass]="getNitrogenStatus()">
                  {{ getNitrogenStatusText() }}
                </div>
              </div>
            </div>

            <div class="sensor-card phosphorus">
              <div class="sensor-icon">
                <img src="https://cdn-icons-png.flaticon.com/512/6678/6678656.png" alt="phosphorus" />
              </div>
              <div class="sensor-content">
                <div class="sensor-value">{{ formatNumber(areaSummary.averages.phosphorus) }}</div>
                <div class="sensor-unit">mg/kg</div>
                <div class="sensor-label">ฟอสฟอรัส (P)</div>
                <div class="sensor-status" [ngClass]="getPhosphorusStatus()">
                  {{ getPhosphorusStatusText() }}
                </div>
              </div>
            </div>

            <div class="sensor-card potassium">
              <div class="sensor-icon">
                <img src="https://cdn-icons-png.flaticon.com/512/6678/6678660.png" alt="potassium" />
              </div>
              <div class="sensor-content">
                <div class="sensor-value">{{ formatNumber(areaSummary.averages.potassium) }}</div>
                <div class="sensor-unit">mg/kg</div>
                <div class="sensor-label">โพแทสเซียม (K)</div>
                <div class="sensor-status" [ngClass]="getPotassiumStatus()">
                  {{ getPotassiumStatusText() }}
                </div>
              </div>
            </div>

            <div class="sensor-card ph">
              <div class="sensor-icon">
                <img src="https://cdn-icons-png.flaticon.com/512/9162/9162345.png" alt="ph" />
              </div>
              <div class="sensor-content">
                <div class="sensor-value">{{ formatNumber(areaSummary.averages.ph, 1) }}</div>
                <div class="sensor-unit">pH</div>
                <div class="sensor-label">ค่าความเป็นกรด-ด่าง</div>
                <div class="sensor-status" [ngClass]="getPhStatus()">
                  {{ getPhStatusText() }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- รายการจุดวัดทั้งหมด -->
        <div class="measurement-points-section" *ngIf="measurementPoints.length > 0">
          <div class="section-title">
            <i class="fas fa-map-marker-alt"></i>
            จุดวัดทั้งหมด ({{ measurementPoints.length }} จุด)
          </div>

          <div class="points-grid" *ngIf="!loading">
            <div class="point-card" *ngFor="let point of measurementPoints; let i = index"
              (click)="showMeasurementPointDetail(point)">

              <!-- Header Section -->
              <div class="point-header">
                <div class="point-number">
                  <i class="fas fa-map-marker-alt"></i>
                  จุดที่ {{ point.measurementPoint || (i + 1) }}
                </div>
                <div class="point-date">
                  <i class="fas fa-calendar"></i>
                  {{ getPointDate(point) }}
                </div>
              </div>

              <!-- ID Section -->
              <div class="point-id">
                <i class="fas fa-hashtag"></i>
                <span class="id-label">Measurement ID:</span>
                <span class="id-value">{{ point.measurementid || point.id || 'ไม่ระบุ' }}</span>
              </div>

              <!-- Areas ID Section -->
              <div class="point-areasid"
                *ngIf="point.areasid && point.areasid !== 'null' && point.areasid !== 'undefined'">
                <i class="fas fa-layer-group"></i>
                <span class="areasid-label">Areas ID:</span>
                <span class="areasid-value">{{ point.areasid }}</span>
              </div>

              <!-- Location Section -->
              <div class="point-location" *ngIf="point.lat && point.lng">
                <i class="fas fa-location-dot"></i>
                <span class="location-label">พิกัด:</span>
                <span class="location-value">{{ point.lat.toFixed(6) }}, {{ point.lng.toFixed(6) }}</span>
              </div>

              <!-- Measurements Section -->
              <div class="point-measurements">
                <div class="measurements-grid">
                  <div class="measurement-item temperature">
                    <i class="fas fa-thermometer-half"></i>
                    <span class="measurement-label">อุณหภูมิ</span>
                    <span class="measurement-value">{{ formatNumber(point.temperature) }}°C</span>
                  </div>

                  <div class="measurement-item moisture">
                    <i class="fas fa-tint"></i>
                    <span class="measurement-label">ความชื้น</span>
                    <span class="measurement-value">{{ formatNumber(point.moisture) }}%</span>
                  </div>

                  <div class="measurement-item nitrogen">
                    <i class="fas fa-atom"></i>
                    <span class="measurement-label">N</span>
                    <span class="measurement-value">{{ formatNumber(point.nitrogen) }}</span>
                  </div>

                  <div class="measurement-item phosphorus">
                    <i class="fas fa-circle"></i>
                    <span class="measurement-label">P</span>
                    <span class="measurement-value">{{ formatNumber(point.phosphorus) }}</span>
                  </div>

                  <div class="measurement-item potassium">
                    <i class="fas fa-circle"></i>
                    <span class="measurement-label">K</span>
                    <span class="measurement-value">{{ formatNumber(point.potassium) }}</span>
                  </div>

                  <div class="measurement-item ph">
                    <i class="fas fa-flask"></i>
                    <span class="measurement-label">pH</span>
                    <span class="measurement-value">{{ formatNumber(point.ph, 1) }}</span>
                  </div>
                </div>
              </div>

              <!-- Actions Section -->
              <div class="point-actions">
                <button class="view-detail-btn">
                  <i class="fas fa-eye"></i>
                  ดูรายละเอียด
                </button>
              </div>
            </div>
          </div>

          <div class="loading-spinner" *ngIf="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>กำลังโหลดข้อมูลจุดวัด...</span>
          </div>
        </div>

        <!-- สรุปผลและคำแนะนำ -->
        <div class="summary-section">
          <div class="section-title">สรุปผลการวัด</div>
          <div class="summary-content">
            <div class="overall-status" [ngClass]="getOverallStatus()">
              <div class="status-icon">
                <i [class]="getOverallStatusIcon()"></i>
              </div>
              <div class="status-text">
                <div class="status-title">{{ getOverallStatusTitle() }}</div>
                <div class="status-description">{{ getOverallStatusDescription() }}</div>
              </div>
            </div>

            <div class="recommendations" *ngIf="getRecommendations().length > 0">
              <h4>คำแนะนำ:</h4>
              <ul>
                <li *ngFor="let recommendation of getRecommendations()">
                  {{ recommendation }}
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- ปุ่มดาวน์โหลดรายงาน -->
        <div class="action-section">
          <button class="download-btn" (click)="downloadReport()">
            <i class="fas fa-download"></i>
            ดาวน์โหลดรายงาน
          </button>
          <button class="share-btn" (click)="shareReport()">
            <i class="fas fa-share-alt"></i>
            แชร์ผลการวัด
          </button>
        </div>
        <!-- Modal สำหรับแสดงรายละเอียดจุดวัด -->
        <div class="point-detail-modal" *ngIf="showPointDetail && selectedPoint" (click)="closePointDetail()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h3>
                <i class="fas fa-map-marker-alt"></i>
                รายละเอียดจุดที่ {{ selectedPoint.measurementPoint }}
              </h3>
              <button class="close-btn" (click)="closePointDetail()">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="modal-body">
              <!-- ข้อมูลตำแหน่ง -->
              <div class="detail-section">
                <div class="detail-title">ตำแหน่ง</div>
                <div class="detail-content">
                  <div class="detail-item">
                    <span class="detail-label">Measurement ID:</span>
                    <span class="detail-value">{{ selectedPoint.id }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Areas ID:</span>
                    <span class="detail-value">{{ selectedPoint.areasid }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">พิกัด:</span>
                    <span class="detail-value">{{ selectedPoint.lat.toFixed(6) }}, {{ selectedPoint.lng.toFixed(6)
                      }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">วันที่:</span>
                    <span class="detail-value">{{ getPointDate(selectedPoint) }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">เวลา:</span>
                    <span class="detail-value">{{ getPointTime(selectedPoint) }}</span>
                  </div>
                </div>
              </div>

              <!-- ข้อมูลการวัด -->
              <div class="detail-section">
                <div class="detail-title">ผลการวัด</div>
                <div class="measurements-grid">
                  <div class="measurement-card temperature">
                    <div class="measurement-icon">
                      <img src="https://cdn-icons-png.flaticon.com/512/3534/3534501.png" alt="temperature" />
                    </div>
                    <div class="measurement-info">
                      <div class="measurement-value">{{ selectedPoint.temperature }}</div>
                      <div class="measurement-unit">°C</div>
                      <div class="measurement-label">อุณหภูมิ</div>
                    </div>
                  </div>

                  <div class="measurement-card moisture">
                    <div class="measurement-icon">
                      <img src="https://cdn-icons-png.flaticon.com/512/6393/6393411.png" alt="moisture" />
                    </div>
                    <div class="measurement-info">
                      <div class="measurement-value">{{ selectedPoint.moisture }}</div>
                      <div class="measurement-unit">%</div>
                      <div class="measurement-label">ความชื้น</div>
                    </div>
                  </div>

                  <div class="measurement-card nitrogen">
                    <div class="measurement-icon">
                      <img src="https://cdn-icons-png.flaticon.com/512/6678/6678672.png" alt="nitrogen" />
                    </div>
                    <div class="measurement-info">
                      <div class="measurement-value">{{ selectedPoint.nitrogen }}</div>
                      <div class="measurement-unit">mg/kg</div>
                      <div class="measurement-label">ไนโตรเจน</div>
                    </div>
                  </div>

                  <div class="measurement-card phosphorus">
                    <div class="measurement-icon">
                      <img src="https://cdn-icons-png.flaticon.com/512/6678/6678656.png" alt="phosphorus" />
                    </div>
                    <div class="measurement-info">
                      <div class="measurement-value">{{ selectedPoint.phosphorus }}</div>
                      <div class="measurement-unit">mg/kg</div>
                      <div class="measurement-label">ฟอสฟอรัส</div>
                    </div>
                  </div>

                  <div class="measurement-card potassium">
                    <div class="measurement-icon">
                      <img src="https://cdn-icons-png.flaticon.com/512/6678/6678660.png" alt="potassium" />
                    </div>
                    <div class="measurement-info">
                      <div class="measurement-value">{{ selectedPoint.potassium }}</div>
                      <div class="measurement-unit">mg/kg</div>
                      <div class="measurement-label">โพแทสเซียม</div>
                    </div>
                  </div>

                  <div class="measurement-card ph">
                    <div class="measurement-icon">
                      <img src="https://cdn-icons-png.flaticon.com/512/9162/9162345.png" alt="ph" />
                    </div>
                    <div class="measurement-info">
                      <div class="measurement-value">{{ selectedPoint.ph }}</div>
                      <div class="measurement-unit">pH</div>
                      <div class="measurement-label">ความเป็นกรด-ด่าง</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn-secondary" (click)="closePointDetail()">
                <i class="fas fa-times"></i>
                ปิด
              </button>
            </div>
          </div>
        </div>
      </div>