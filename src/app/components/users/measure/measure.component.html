<div class="measure-container">
  <div class="card">
    <i class="fas fa-arrow-left back" (click)="goBack()"></i>

    <div class="header">
    </div>

    <h2 class="title">Customize your own NPK</h2>

    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô -->
    <div class="control-buttons">
      <button class="control-btn" (click)="toggleUserInfo()" [ngClass]="{ active: showUserInfo }">
        {{ showUserInfo ? '‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' : '‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' }}
      </button>
      <button class="control-btn" (click)="toggleDeviceInfo()" [ngClass]="{ active: showDeviceInfo }">
        {{ showDeviceInfo ? '‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' : '‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' }}
      </button>
      <button class="control-btn" (click)="toggleMainMap()" [ngClass]="{ active: showMainMap }">
        {{ showMainMap ? '‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà' : '‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà' }}
      </button>
    </div>

    <!-- ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User -->
    <div class="user-info" *ngIf="showUserInfo">
      <div class="info-row">
        <span class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</span>
        <span class="value">{{ userName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
      </div>
      <div class="info-row">
        <span class="label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</span>
        <span class="value">{{ userEmail || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
      </div>
      <div class="info-row">
        <span class="label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span>
        <span class="value">{{ userPhone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
      </div>
    </div>

    <!-- ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Device -->
    <div class="device-info" *ngIf="showDeviceInfo">
      <div class="info-row">
        <span class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</span>
        <span class="value">{{ deviceName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
      </div>
      <div class="info-row">
        <span class="label">Device ID:</span>
        <span class="value">{{ deviceId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
      </div>
      <div class="info-row">
        <span class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
        <span class="status-indicator" [ngClass]="{
            online: deviceStatus === 'online',
            offline: deviceStatus === 'offline'
          }">
          <span class="status-dot"></span>
          <span class="status-text">{{ deviceStatus === 'online' ? '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : '‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå' }}</span>
        </span>
      </div>
    </div>

    <!-- ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase -->
    <div class="connection-status">
      <span class="status-indicator" [ngClass]="{
          connected: isLiveDataConnected,
          disconnected: !isLiveDataConnected
        }">
        <span class="status-dot"></span>
        <span class="status-text">
          {{ isLiveDataConnected ? '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå' : '‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå' }}
        </span>
      </span>
    </div>

    <button class="save-btn" (click)="saveMeasurement()" [disabled]="isLoading || !isLiveDataConnected">
      <span *ngIf="!isLoading && isLiveDataConnected">‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤</span>
      <span *ngIf="!isLoading && !isLiveDataConnected">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ - ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</span>
      <span *ngIf="isLoading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>
    </button>

    <div class="grid">
      <div class="sensor-box">
        <img src="https://cdn-icons-png.flaticon.com/512/4850/4850456.png" class="sensor-icon" alt="Temperature Icon" />
        <span class="value">{{ temperature }}</span>
        <span class="unit">¬∞C</span>
        <p class="label">Temperature</p>
      </div>
      <div class="sensor-box">
        <img src="https://cdn-icons-png.flaticon.com/512/4148/4148460.png" class="sensor-icon" alt="Moisture Icon" />
        <span class="value">{{ moisture }}</span>
        <span class="unit">%</span>
        <p class="label">Moisture</p>
      </div>
      <div class="sensor-box">
        <img src="https://cdn-icons-png.flaticon.com/512/6678/6678672.png" class="sensor-icon" alt="Nitrogen Icon" />
        <span class="value">{{ nitrogen }}</span>
        <span class="unit">mg/kg</span>
        <p class="label">Nitrogen</p>
      </div>
      <div class="sensor-box">
        <img src="https://cdn-icons-png.flaticon.com/512/6678/6678656.png" class="sensor-icon" alt="Phosphorus Icon" />
        <span class="value">{{ phosphorus }}</span>
        <span class="unit">mg/kg</span>
        <p class="label">Phosphorus</p>
      </div>
      <div class="sensor-box">
        <img src="https://cdn-icons-png.flaticon.com/512/6678/6678660.png" class="sensor-icon" alt="Potassium Icon" />
        <span class="value">{{ potassium }}</span>
        <span class="unit">mg/kg</span>
        <p class="label">Potassium</p>
      </div>
      <div class="sensor-box">
        <img src="https://cdn-icons-png.flaticon.com/512/4236/4236740.png" class="sensor-icon" alt="PH Icon" />
        <span class="value">{{ ph }}</span>
        <span class="unit">%</span>
        <p class="label">Potential of Hydrogen (PH)</p>
      </div>
    </div>

    <!-- ‚úÖ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å -->
    <div class="map-container" *ngIf="showMainMap">
      <div #mapContainer class="map" style="width: 100%; height: 300px;"></div>
    </div>

    <div class="admin" (click)="goToContactAdmin()">
      <img src="https://cdn-icons-png.flaticon.com/512/2914/2914688.png" alt="Admin Icon" />
      ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin
    </div>
    <button class="history-btn" (click)="goToHistory()">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î</button>

    <!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î -->
    <div class="popup-overlay" *ngIf="showPopup" (click)="closePopup()">
      <div class="popup-content" (click)="stopPropagation($event)">
        <h3>üó∫Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡∏î‡∏¥‡∏ô</h3>
        <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏à‡∏∏‡∏î)</p>
        <p>‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: <strong>{{ selectedPoints.length }}</strong> ‡∏à‡∏∏‡∏î</p>
        <p *ngIf="selectedPoints.length >= 3" class="polygon-info">
          ‚úÖ ‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡πâ‡∏ß ({{ selectedPoints.length }} ‡∏à‡∏∏‡∏î)
        </p>
        <p *ngIf="selectedPoints.length < 3" class="polygon-warning">
          ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î
        </p>

        <div class="map-popup" style="width: 100%; height: 400px; border: 2px solid #00aaff; border-radius: 8px;"></div>

        <div class="selection-info" *ngIf="selectedPoints.length > 0">
          <p>üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ({{ selectedPoints.length }} ‡∏à‡∏∏‡∏î):</p>
          <div class="coordinates-list">
            <div *ngFor="let point of selectedPoints; let i = index" class="coordinate-item">
              ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà {{ i + 1 }}: {{ point[0].toFixed(6) }}, {{ point[1].toFixed(6) }}
            </div>
          </div>
        </div>

        <div class="measurement-info" *ngIf="measurementPoints.length > 0">
          <p>üéØ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏±‡∏î ({{ measurementPoints.length }} ‡∏à‡∏∏‡∏î):</p>
          <div class="coordinates-list">
            <div *ngFor="let point of measurementPoints; let i = index" class="coordinate-item measurement-point">
              ‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà {{ i + 1 }}: {{ point[0].toFixed(6) }}, {{ point[1].toFixed(6) }}
            </div>
          </div>
        </div>

        <div class="popup-buttons">
          <button class="btn-secondary" (click)="clearMarks()" [disabled]="selectedPoints.length === 0">
            üóëÔ∏è ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </button>
          <button class="btn-primary" (click)="confirmArea()" [disabled]="selectedPoints.length < 3">
            ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ({{ selectedPoints.length }} ‡∏à‡∏∏‡∏î)
          </button>
          <button class="btn-cancel" (click)="closePopup()">
            ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
        </div>

        <div class="instructions">
          <p><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</strong></p>
          <ul>
            <li>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î</li>
            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</li>
            <li>‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</li>
            <li>‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™</li>
            <li>‡∏Å‡∏î "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à</li>
          </ul>
        </div>
      </div>
    </div>

  </div>
</div>