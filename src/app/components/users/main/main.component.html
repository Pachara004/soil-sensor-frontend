<div class="container">
  <button (click)="logout()" class="logout-btn">ออกจากระบบ</button>

  <div class="card" *ngIf="devices && devices.length; else loadingState">
    <!-- ไอคอนบนสุด -->
    <img
      src="https://cdn.iconscout.com/icon/premium/png-256-thumb/soil-sensor-4449978-3688706.png"
      class="chip-icon"
      alt="chip"
    />

    <!-- ข้อมูลผู้ใช้ -->
    <div class="user-box">
      <span class="label">User : </span>
      <span class="value">{{ userID }}</span>
    </div>

    <!-- ข้อมูลชื่ออุปกรณ์ -->
    <div class="device-box">
      <img
        src="https://cdn.iconscout.com/icon/premium/png-256-thumb/soil-sensor-4449978-3688706.png"
        class="chip-icon"
        alt="chip"
      />
      <span class="label-orange">ชื่ออุปกรณ์ :</span>

      <!-- แสดงชื่ออุปกรณ์ (กรณี <= 1 ชิ้น) -->
      <span class="value" *ngIf="devices.length <= 1">
        {{ (selectedDevice?.displayName) || (devices[0].displayName) || 'ไม่มีอุปกรณ์' }}
      </span>

      <!-- เลือกอุปกรณ์ (กรณี > 1 ชิ้น) -->
      <select
        class="device-select"
        *ngIf="devices.length > 1"
        [(ngModel)]="selectedDeviceId"
        (ngModelChange)="onDeviceChange()"
        aria-label="เลือกอุปกรณ์"
      >
        <option *ngFor="let device of devices" [value]="device.id">
          {{ device.displayName }}
        </option>
      </select>

      <!-- สถานะ Online/Offline ของ "อุปกรณ์ที่เลือก" -->
      <span
        class="status-indicator"
        [ngClass]="{
          online: selectedDevice?.status === 'online',
          offline: selectedDevice?.status !== 'online'
        }"
      >
        <span class="status-dot"></span>
        <span class="status-text">
          {{ selectedDevice?.status === 'online' ? 'Online' : 'Offline' }}
        </span>
      </span>
    </div>

    <div class="time-box">
      <span class="label">เวลา :</span>
      {{ currentTime }}
    </div>

    <!-- ปุ่มข้อมูลผู้ใช้ -->
    <div class="user-icon" (click)="goToProfile()" style="cursor: pointer;">
      <img
        src="https://www.iconpacks.net/icons/2/free-user-icon-3296-thumb.png"
        alt="user"
      />
      <div class="text">ข้อมูลผู้ใช้</div>
    </div>

    <!-- ปุ่มประวัติการวัดค่า -->
    <button class="btn-history" (click)="goToHistory()">ประวัติการวัดค่า</button>

    <!-- ปุ่มวัดค่า -->
    <button class="btn-main" (click)="goToMeasure()">วัดค่า</button>

    <!-- ปุ่มติดต่อแอดมิน -->
    <div class="admin" (click)="goToContactAdmin()">
      <img src="https://cdn-icons-png.flaticon.com/512/9703/9703596.png" alt="admin" />
      <div>ติดต่อ Admin</div>
    </div>

    <!-- แบบฟอร์ม “ขอผูกอุปกรณ์” -->
    <div class="claim-device-box">
      <div class="claim-title">ขอผูกอุปกรณ์ของฉัน</div>

      <div class="claim-row">
        <input
          class="claim-input"
          type="text"
          [(ngModel)]="claimDeviceId"
          (keyup.enter)="requestDeviceClaim()"
          placeholder="ใส่ Device ID เช่น esp32-soil-01"
          aria-label="Device ID"
        />

        <button
          class="claim-btn"
          [disabled]="requestingClaim || !claimDeviceId.trim()"
          (click)="requestDeviceClaim()"
          aria-label="ส่งคำขอผูกอุปกรณ์"
        >
          <span *ngIf="!requestingClaim">ส่งคำขอ</span>
          <span *ngIf="requestingClaim" class="spinner"></span>
        </button>
      </div>

      <div class="claim-status" *ngIf="lastClaimMessage">
        <span
          class="status-dot"
          [ngClass]="{
            ok: lastClaimType === 'ok',
            warn: lastClaimType === 'warn',
            err: lastClaimType === 'err'
          }"
        ></span>
        {{ lastClaimMessage }}
      </div>
    </div>
  </div>

  <ng-template #loadingState>
    <div class="card">
      <div class="device-box">
        <span class="label-orange">ชื่ออุปกรณ์ :</span>
        <span class="value">กำลังโหลด...</span>
        <span class="status-indicator offline">
          <span class="status-dot"></span>
          <span class="status-text">Offline</span>
        </span>
      </div>
    </div>
  </ng-template>
</div>
