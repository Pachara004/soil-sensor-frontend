<div class="container">
  <button (click)="logout()" class="logout-btn">ออกจากระบบ</button>

  <div class="card">
    <!-- ไอคอนบนสุด -->
    <img src="https://cdn.iconscout.com/icon/premium/png-256-thumb/soil-sensor-4449978-3688706.png" class="chip-icon"
      alt="chip" />

    <!-- ข้อมูลผู้ใช้ -->
    <div class="user-box">
      <span class="label">User : </span>
      <span class="value">{{ userName || userEmail || userID }}</span>
    </div>

    <!-- ข้อมูลชื่ออุปกรณ์ -->
    <div class="device-box">
      <img src="https://cdn.iconscout.com/icon/premium/png-256-thumb/soil-sensor-4449978-3688706.png" class="chip-icon"
        alt="chip" />
      <span class="label-orange">ชื่ออุปกรณ์ :</span>

      <!-- แสดงชื่ออุปกรณ์ -->
      <span class="value" *ngIf="devices.length === 0">
        ไม่พบอุปกรณ์
      </span>
      <!-- แสดงข้อความเมื่อยังไม่ได้เลือกอุปกรณ์ -->
      <span class="value" *ngIf="devices.length > 1 && !selectedDevice">
        กรุณาเลือกอุปกรณ์
      </span>

      <!-- เลือกอุปกรณ์ (กรณี > 1 ชิ้น) -->
      <select class="device-select" *ngIf="devices.length > 1" [(ngModel)]="selectedDeviceId"
        (ngModelChange)="onDeviceChange()" aria-label="เลือกอุปกรณ์">
        <option value="" disabled>-- เลือกอุปกรณ์ --</option>
        <option *ngFor="let device of devices" [value]="device.deviceid">
          {{ device.device_name || device.deviceid }}
        </option>
      </select>

      <!-- สถานะ Online/Offline ของ "อุปกรณ์ที่เลือก" -->
      <span class="status-indicator" [ngClass]="{
          online: selectedDevice?.status === 'online',
          offline: selectedDevice?.status !== 'online' || devices.length === 0
        }">
        <span class="status-dot"></span>
        <span class="status-text">
          {{ devices.length === 0 ? 'Offline' : (selectedDevice?.status === 'online' ? 'Online' : 'Offline') }}
        </span>
      </span>
    </div>

    <div class="time-box">
      <span class="label">เวลา :</span>
      {{ currentTime }}
    </div>

    <!-- ปุ่มข้อมูลผู้ใช้ -->
    <div class="user-icon" (click)="goToProfile()" style="cursor: pointer;">
      <img src="https://www.iconpacks.net/icons/2/free-user-icon-3296-thumb.png" alt="user" />
      <div class="text">ข้อมูลผู้ใช้</div>
    </div>

    <!-- ปุ่มประวัติการวัดค่า -->
    <button class="btn-history" (click)="goToHistory()">ประวัติการวัดค่า</button>

    <!-- ปุ่มวัดค่า -->
    <button class="btn-main" (click)="goToMeasure()">วัดค่า</button>

    <!-- ปุ่มติดต่อแอดมิน -->
    <div class="admin" (click)="goToContactAdmin()">
      <img src="https://cdn-icons-png.flaticon.com/512/9703/9703596.png" alt="admin" />
      <div>ติดต่อ Admin</div>
    </div>

    <!-- แบบฟอร์ม “ขอผูกอุปกรณ์” -->
    <div class="claim-device-box" role="group" aria-labelledby="claim-title">
      <div id="claim-title" class="claim-title">เพิ่มอุปกรณ์ของฉัน</div>

      <div class="claim-row">
        <input class="claim-input" type="text" [(ngModel)]="claimDeviceId" (keyup.enter)="addNewDevice()"
          placeholder="ใส่ Device ID เช่น esp32-soil-01" aria-label="Device ID" aria-describedby="claim-help" />

        <button class="claim-btn" [disabled]="requestingClaim || !claimDeviceId.trim()" (click)="addNewDevice()"
          aria-label="เพิ่มอุปกรณ์">
          <span *ngIf="!requestingClaim">เพิ่มอุปกรณ์</span>
          <span *ngIf="requestingClaim" class="spinner" aria-hidden="true"></span>
        </button>
      </div>

      <small id="claim-help" class="claim-help">
        พิมพ์ Device ID แล้วกด Enter หรือคลิก "เพิ่มอุปกรณ์" เพื่อเพิ่มอุปกรณ์ให้บัญชีของคุณ
      </small>
      <div class="claim-status" *ngIf="lastClaimMessage">
        <span class="status-dot" [ngClass]="{
            ok: lastClaimType === 'ok',
            warn: lastClaimType === 'warn',
            err: lastClaimType === 'err'
          }"></span>
        {{ lastClaimMessage }}
      </div>
    </div>
  </div>

</div>