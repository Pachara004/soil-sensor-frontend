<div class="measure-container" (click)="closeCardMenu()">
  <!-- Back arrow ย้ายออกจาก card -->
  <i class="fas fa-arrow-left back" (click)="goBack()"></i>

  <!-- จุด 3 จุดย้ายออกจาก card -->
  <div class="card-menu" (click)="toggleCardMenu(); $event.stopPropagation()">
    <i class="fas fa-ellipsis-v"></i>
    <div class="menu-dropdown" *ngIf="showCardMenu" (click)="$event.stopPropagation()">
      <div class="menu-item" (click)="goToProfile(); closeCardMenu()">
        <i class="fas fa-user"></i>
        ข้อมูลผู้ใช้
      </div>
      <div class="menu-item" (click)="goToContactAdmin(); closeCardMenu()">
        <i class="fas fa-user-shield"></i>
        แจ้งแอดมิน
      </div>
    </div>
  </div>

  <div class="card" (click)="$event.stopPropagation()">

    <div class="header">
      <div class="user-summary">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-details">
          <h3 class="user-name">{{ userName || 'ไม่ระบุ' }}</h3>
          <p class="user-email">{{ userEmail || 'ไม่ระบุ' }}</p>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="subtitle">ประวัติการวัดค่า</div>
      <div class="device-box">
        <span>ชื่ออุปกรณ์:</span>
        <select [(ngModel)]="deviceId" (ngModelChange)="onDeviceChange()">
          <option *ngFor="let device of devices" [value]="device">{{ device }}</option>
        </select>
      </div>
    </div>

    <div *ngIf="isLoading" class="loading">
      <mat-spinner></mat-spinner>
      <p>กำลังโหลดข้อมูล...</p>
    </div>

    <div *ngIf="!isLoading && !showAreaDetails" class="history-list">
      <div class="area-title">รายการพื้นที่การวัด</div>
      <div *ngFor="let area of areaGroups" class="area-item">
        <div class="area-header">
          <h3 class="area-name">{{ getDisplayAreaName(area) }}</h3>
          <div class="area-info-row">
            <div class="area-info-item">
              <i class="fas fa-map-marker-alt"></i>
              <span class="info-label">จุดวัด:</span>
              <span class="info-value">{{ area.totalMeasurements }} จุด</span>
              <span class="info-detail" *ngIf="area.totalMeasurements > 0">(Measurement ID: {{
                getMeasurementIdRange(area) }})</span>
            </div>
            <div class="area-info-item">
              <i class="fas fa-expand-arrows-alt"></i>
              <span class="info-label">ขนาด:</span>
              <span class="info-value" *ngIf="area.areaSizeFormatted">{{ area.areaSizeFormatted }}</span>
              <span class="info-value" *ngIf="!area.areaSizeFormatted">ไม่ระบุ</span>
            </div>
            <div class="area-info-item">
              <i class="fas fa-calendar-alt"></i>
              <span class="info-label">วันที่ล่าสุด:</span>
              <span class="info-value">{{ area.lastMeasurementDate | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>
        </div>
        <div class="area-averages">
          <div class="avg-grid">
            <div class="avg-item">
              <span class="avg-label">อุณหภูมิ</span>
              <span class="avg-value">{{ formatNumber(area.averages.temperature) }}°C</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">ความชื้น</span>
              <span class="avg-value">{{ formatNumber(area.averages.moisture) }}%</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">N</span>
              <span class="avg-value">{{ formatNumber(area.averages.nitrogen) }}</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">P</span>
              <span class="avg-value">{{ formatNumber(area.averages.phosphorus) }}</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">K</span>
              <span class="avg-value">{{ formatNumber(area.averages.potassium) }}</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">pH</span>
              <span class="avg-value">{{ formatNumber(area.averages.ph, 1) }}</span>
            </div>
          </div>
        </div>
        <div class="area-actions">
          <button class="detail-btn" (click)="viewAreaDetails(area)">ดูรายละเอียด</button>
          <button class="stats-btn" (click)="showAreaStatistics(area)">สถิติ</button>
          <button class="points-btn" (click)="viewAllMeasurementPoints(area)">ดูจุดวัดทั้งหมด</button>
        </div>
      </div>
      <div *ngIf="areaGroups.length === 0" class="empty">ไม่พบข้อมูลการวัดค่า</div>
    </div>

    <div *ngIf="!isLoading && showAreaDetails && selectedArea" class="area-details-view">
      <!-- Header Section -->
      <div class="area-detail-header">
        <button class="back-to-list" (click)="backToAreaList()">
          <i class="fas fa-arrow-left"></i> กลับ
        </button>
        <div class="area-title-section">
          <h3>{{ selectedArea.areaName }}</h3>
          <div class="area-info">
            <span class="area-date">{{ selectedArea.lastMeasurementDate | date:'dd/MM/yyyy' }}</span>
            <span class="area-size">{{ selectedArea.areaSizeFormatted }}</span>
            <span class="area-points">{{ selectedArea.totalMeasurements }} จุดวัด</span>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <div class="area-summary">
        <h4>
          <i class="fas fa-map"></i>
          แผนที่พื้นที่วัด
        </h4>
        <div id="mapContainer" style="height: 400px; width: 100%; border-radius: 12px; border: 2px solid #e0e0e0;">
        </div>
        <p style="text-align: center; margin-top: 10px; color: #666;">
          <i class="fas fa-info-circle"></i>
          คลิกที่จุดสีเขียวเพื่อดูรายละเอียดการวัดแต่ละจุด
        </p>
      </div>

      <!-- Summary Statistics Section -->
      <div class="area-summary">
        <h4>
          <i class="fas fa-chart-line"></i>
          สรุปข้อมูลพื้นที่
        </h4>
        <div class="area-stats-grid">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">จำนวนจุดวัด</div>
              <div class="stat-value">{{ selectedArea.totalMeasurements }} จุด</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-expand-arrows-alt"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">ขนาดพื้นที่</div>
              <div class="stat-value">{{ selectedArea.areaSizeFormatted }}</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">วันที่วัดล่าสุด</div>
              <div class="stat-value">{{ selectedArea.lastMeasurementDate | date:'dd/MM/yyyy HH:mm' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Average Values Section -->
      <div class="area-summary">
        <h4>
          <i class="fas fa-calculator"></i>
          ค่าเฉลี่ยการวัดทั้งหมด ({{ selectedArea.totalMeasurements }} จุด)
        </h4>
        <div class="summary-grid">
          <div class="summary-item temperature">
            <div class="summary-icon">
              <i class="fas fa-thermometer-half"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">อุณหภูมิ</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.temperature) }}°C</span>
            </div>
          </div>

          <div class="summary-item moisture">
            <div class="summary-icon">
              <i class="fas fa-tint"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">ความชื้น</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.moisture) }}%</span>
            </div>
          </div>

          <div class="summary-item nitrogen">
            <div class="summary-icon">
              <i class="fas fa-atom"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">ไนโตรเจน (N)</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.nitrogen) }} mg/kg</span>
            </div>
          </div>

          <div class="summary-item phosphorus">
            <div class="summary-icon">
              <i class="fas fa-circle"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">ฟอสฟอรัส (P)</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.phosphorus) }} mg/kg</span>
            </div>
          </div>

          <div class="summary-item potassium">
            <div class="summary-icon">
              <i class="fas fa-circle"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">โพแทสเซียม (K)</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.potassium) }} mg/kg</span>
            </div>
          </div>

          <div class="summary-item ph">
            <div class="summary-icon">
              <i class="fas fa-flask"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">ค่า pH</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.ph, 1) }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="area-summary recommendation-section">
        <h4>คำแนะนำการปรับปรุงดิน</h4>
        <p class="recommendation-text">{{ recommendSoilImprovement(selectedArea).message }}</p>
        <h4>สูตรปุ๋ยที่แนะนำ</h4>
        <div class="summary-grid">
          <div *ngFor="let fertilizer of recommendSoilImprovement(selectedArea).fertilizers"
            class="summary-item fertilizer-item">
            <span class="summary-label">{{ fertilizer.formula }}</span>
            <span class="summary-value">{{ fertilizer.amount }} - {{ fertilizer.description }}</span>
          </div>
        </div>
        <h4>พืชที่เหมาะสม</h4>
        <p class="crop-text">{{ recommendCrops(selectedArea).join(', ') }}</p>
      </div>

      <div class="measurements-list">
        <h4>รายการจุดวัด (Measurement ID)</h4>
        <div *ngFor="let measurement of selectedArea.measurements" class="measurement-item">
          <div class="measurement-info">
            <div class="measurement-point">Measurement ID: {{ measurement['measurementid'] || measurement['id'] ||
              'ไม่ระบุ'
              }}</div>
            <div class="measurement-location">{{ measurement.location || 'ไม่ระบุตำแหน่ง' }}</div>
            <div class="measurement-date">{{ measurement.measurement_date || measurement.date || 'ไม่ระบุวันที่' }}
            </div>
            <div class="measurement-areasid">Areas ID: {{ measurement['areasid'] || 'ไม่ระบุ' }}</div>
          </div>
          <button class="view-detail-btn" (click)="viewMeasurementDetail(measurement)">ดูรายละเอียด</button>
        </div>
      </div>
    </div>
  </div>
</div>