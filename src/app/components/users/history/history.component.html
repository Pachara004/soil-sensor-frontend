<div class="measure-container" (click)="closeCardMenu()">
  <!-- Back arrow ย้ายออกจาก card -->
  <i class="fas fa-arrow-left back" (click)="goBack()"></i>

  <!-- จุด 3 จุดย้ายออกจาก card -->
  <div class="card-menu" (click)="toggleCardMenu(); $event.stopPropagation()">
    <i class="fas fa-ellipsis-v"></i>
    <div class="menu-dropdown" *ngIf="showCardMenu" (click)="$event.stopPropagation()">
      <div class="menu-item" (click)="goToProfile(); closeCardMenu()">
        <i class="fas fa-user"></i>
        ข้อมูลผู้ใช้
      </div>
      <div class="menu-item" (click)="goToContactAdmin(); closeCardMenu()">
        <i class="fas fa-user-shield"></i>
        แจ้งแอดมิน
      </div>
    </div>
  </div>

  <div class="card" (click)="$event.stopPropagation()">

    <div class="header">
      <div class="user-summary">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-details">
          <h3 class="user-name">{{ userName || 'ไม่ระบุ' }}</h3>
          <p class="user-email">{{ userEmail || 'ไม่ระบุ' }}</p>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="subtitle">ประวัติการวัดค่า</div>
      <div class="device-box">
        <span>ชื่ออุปกรณ์:</span>
        <select [(ngModel)]="deviceId" (ngModelChange)="onDeviceChange()">
          <option *ngFor="let device of devices" [value]="device">{{ device }}</option>
        </select>
      </div>
    </div>

    <div *ngIf="isLoading" class="loading">
      <mat-spinner></mat-spinner>
      <p>กำลังโหลดข้อมูล...</p>
    </div>

    <div *ngIf="!isLoading && !showAreaDetails" class="history-list">
      <div class="area-title">รายการพื้นที่การวัด</div>
      <div *ngFor="let area of areaGroups" class="area-item">
        <div class="area-header">
          <h3 class="area-name">{{ getDisplayAreaName(area) }}</h3>
          <div class="area-info-row">
            <div class="area-info-item">
              <i class="fas fa-map-marker-alt"></i>
              <span class="info-label">จุดวัด:</span>
              <span class="info-value">{{ area.totalMeasurements }} จุด</span>
              <span class="info-detail" *ngIf="area.totalMeasurements > 0">(Measurement ID: {{
                getMeasurementIdRange(area) }})</span>
            </div>
            <div class="area-info-item">
              <i class="fas fa-calendar-alt"></i>
              <span class="info-label">วันที่ล่าสุด:</span>
              <span class="info-value">{{ area.lastMeasurementDate | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>
        </div>
        <div class="area-averages">
          <div class="avg-grid">
            <div class="avg-item">
              <span class="avg-label">อุณหภูมิ</span>
              <span class="avg-value">{{ formatNumber(area.averages.temperature) }}°C</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">ความชื้น</span>
              <span class="avg-value">{{ formatNumber(area.averages.moisture) }}%</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">N</span>
              <span class="avg-value">{{ formatNumber(area.averages.nitrogen) }}</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">P</span>
              <span class="avg-value">{{ formatNumber(area.averages.phosphorus) }}</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">K</span>
              <span class="avg-value">{{ formatNumber(area.averages.potassium) }}</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">pH</span>
              <span class="avg-value">{{ formatNumber(area.averages.ph, 1) }}</span>
            </div>
          </div>
        </div>
        <div class="area-actions">
          <button class="detail-btn" (click)="viewAreaDetails(area)">ดูรายละเอียด</button>
          <button class="stats-btn" (click)="showAreaStatistics(area)">สถิติ</button>
        </div>
      </div>
      <div *ngIf="areaGroups.length === 0" class="empty">ไม่พบข้อมูลการวัดค่า</div>
    </div>

    <div *ngIf="!isLoading && showAreaDetails && selectedArea" class="area-details-view">
      <!-- Header Section -->
      <div class="area-detail-header">
        <button class="back-to-list" (click)="backToAreaList()">
          <i class="fas fa-arrow-left"></i> กลับ
        </button>
        <div class="area-title-section">
          <h3>{{ selectedArea.areaName }}</h3>
          <div class="area-info">
            <span class="area-date">{{ selectedArea.lastMeasurementDate | date:'dd/MM/yyyy' }}</span>
            <span class="area-points">{{ selectedArea.totalMeasurements }} จุดวัด</span>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <div class="area-summary">
        <h4>
          <i class="fas fa-map"></i>
          แผนที่พื้นที่วัด
        </h4>
        <div id="mapContainer" style="height: 400px; width: 100%; border-radius: 12px; border: 2px solid #e0e0e0;">
        </div>

        <!-- Enhanced Instruction Bar -->
        <div class="map-instruction-bar">
          <div class="instruction-content">
            <div class="instruction-icon">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="instruction-text">
              <span class="instruction-main">คลิกที่จุดสีเขียวเพื่อดูรายละเอียดการวัดแต่ละจุด</span>
              <span class="instruction-sub">Click on green markers to view measurement details</span>
            </div>
            <div class="instruction-visual">
              <div class="marker-preview">
                <div class="preview-marker"></div>
                <span class="preview-label">จุดวัด</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Statistics Section -->
      <div class="area-summary">
        <h4>
          <i class="fas fa-chart-line"></i>
          สรุปข้อมูลพื้นที่
        </h4>
        <div class="area-stats-grid">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">จำนวนจุดวัด</div>
              <div class="stat-value">{{ selectedArea.totalMeasurements }} จุด</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">วันที่วัดล่าสุด</div>
              <div class="stat-value">{{ selectedArea.lastMeasurementDate | date:'dd/MM/yyyy HH:mm' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Average Values Section -->
      <div class="area-summary">
        <h4>
          <i class="fas fa-calculator"></i>
          ค่าเฉลี่ยการวัดทั้งหมด ({{ selectedArea.totalMeasurements }} จุด)
        </h4>

        <!-- Main Measurement Cards -->
        <div class="measurement-cards-grid">
          <div class="measurement-card temperature-card">
            <div class="card-border temperature-border"></div>
            <div class="card-icon">
              <img src="https://cdn-icons-png.flaticon.com/512/3534/3534501.png" alt="temperature" />
            </div>
            <div class="card-content">
              <div class="card-label">อุณหภูมิ</div>
              <div class="card-value">{{ formatNumber(selectedArea.averages.temperature) }}°C</div>
            </div>
          </div>

          <div class="measurement-card moisture-card">
            <div class="card-border moisture-border"></div>
            <div class="card-icon">
              <img src="https://cdn-icons-png.flaticon.com/512/6393/6393411.png" alt="moisture" />
            </div>
            <div class="card-content">
              <div class="card-label">ความชื้น</div>
              <div class="card-value">{{ formatNumber(selectedArea.averages.moisture) }}%</div>
            </div>
          </div>

          <div class="measurement-card nitrogen-card">
            <div class="card-border nitrogen-border"></div>
            <div class="card-icon">
              <img src="https://cdn-icons-png.flaticon.com/512/6678/6678672.png" alt="nitrogen" />
            </div>
            <div class="card-content">
              <div class="card-label">ไนโตรเจน (N)</div>
              <div class="card-value">{{ formatNumber(selectedArea.averages.nitrogen) }} mg/kg</div>
            </div>
          </div>

          <div class="measurement-card phosphorus-card">
            <div class="card-border phosphorus-border"></div>
            <div class="card-icon">
              <img src="https://cdn-icons-png.flaticon.com/512/6678/6678656.png" alt="phosphorus" />
            </div>
            <div class="card-content">
              <div class="card-label">ฟอสฟอรัส (P)</div>
              <div class="card-value">{{ formatNumber(selectedArea.averages.phosphorus) }} mg/kg</div>
            </div>
          </div>

          <div class="measurement-card potassium-card">
            <div class="card-border potassium-border"></div>
            <div class="card-icon">
              <img src="https://cdn-icons-png.flaticon.com/512/6678/6678660.png" alt="potassium" />
            </div>
            <div class="card-content">
              <div class="card-label">โพแทสเซียม (K)</div>
              <div class="card-value">{{ formatNumber(selectedArea.averages.potassium) }} mg/kg</div>
            </div>
          </div>

          <div class="measurement-card ph-card">
            <div class="card-border ph-border"></div>
            <div class="card-icon">
              <img src="https://cdn-icons-png.flaticon.com/512/9162/9162345.png" alt="ph" />
            </div>
            <div class="card-content">
              <div class="card-label">ค่า pH</div>
              <div class="card-value">{{ formatNumber(selectedArea.averages.ph, 1) }}</div>
            </div>
          </div>
        </div>

        <!-- Summary Results Panel -->
        <div class="summary-results-panel">
          <div class="panel-header">
            <div class="panel-icon">
              <i class="fas fa-chart-bar"></i>
            </div>
            <h5>ผลลัพธ์การคำนวณค่าเฉลี่ย</h5>
          </div>
          <div class="results-list">
            <div class="result-item">
              <div class="result-icon temperature-icon">
                <i class="fas fa-thermometer-half"></i>
              </div>
              <span class="result-label">อุณหภูมิเฉลี่ย:</span>
              <span class="result-value">{{ formatNumber(selectedArea.averages.temperature) }}°C</span>
            </div>
            <div class="result-item">
              <div class="result-icon moisture-icon">
                <i class="fas fa-tint"></i>
              </div>
              <span class="result-label">ความชื้นเฉลี่ย:</span>
              <span class="result-value">{{ formatNumber(selectedArea.averages.moisture) }}%</span>
            </div>
            <div class="result-item">
              <div class="result-icon ph-icon">
                <i class="fas fa-flask"></i>
              </div>
              <span class="result-label">pH เฉลี่ย:</span>
              <span class="result-value">{{ formatNumber(selectedArea.averages.ph, 1) }}</span>
            </div>
            <div class="result-item">
              <div class="result-icon nitrogen-icon">
                <i class="fas fa-seedling"></i>
              </div>
              <span class="result-label">ไนโตรเจนเฉลี่ย:</span>
              <span class="result-value">{{ formatNumber(selectedArea.averages.nitrogen) }} mg/kg</span>
            </div>
            <div class="result-item">
              <div class="result-icon phosphorus-icon">
                <i class="fas fa-snowflake"></i>
              </div>
              <span class="result-label">ฟอสฟอรัสเฉลี่ย:</span>
              <span class="result-value">{{ formatNumber(selectedArea.averages.phosphorus) }} mg/kg</span>
            </div>
            <div class="result-item">
              <div class="result-icon potassium-icon">
                <i class="fas fa-bolt"></i>
              </div>
              <span class="result-label">โพแทสเซียมเฉลี่ย:</span>
              <span class="result-value">{{ formatNumber(selectedArea.averages.potassium) }} mg/kg</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Fertilizer Recommendation Section -->
      <div class="area-summary recommendation-section">
        <h4>
          <i class="fas fa-seedling"></i>
          คำแนะนำการปรับปรุงดินและปุ๋ย
        </h4>
        <div class="recommendation-card">
          <div class="recommendation-header">
            <i class="fas fa-lightbulb"></i>
            <h5>การวิเคราะห์ดิน</h5>
          </div>
          <p class="recommendation-text">{{ recommendSoilImprovement(selectedArea).message }}</p>
        </div>

        <div class="fertilizer-recommendations">
          <h5>
            <i class="fas fa-flask"></i>
            สูตรปุ๋ยที่แนะนำ
          </h5>
          <div class="fertilizer-grid">
            <div *ngFor="let fertilizer of recommendSoilImprovement(selectedArea).fertilizers" class="fertilizer-card">
              <div class="fertilizer-icon">
                <i class="fas fa-pills"></i>
              </div>
              <div class="fertilizer-content">
                <h6>{{ fertilizer.formula }}</h6>
                <p class="fertilizer-amount">{{ fertilizer.amount }}</p>
                <p class="fertilizer-description">{{ fertilizer.description }}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="crop-recommendations">
          <h5>
            <i class="fas fa-leaf"></i>
            พืชที่เหมาะสมสำหรับพื้นที่นี้
          </h5>
          <div class="crop-tags">
            <span *ngFor="let crop of recommendCrops(selectedArea)" class="crop-tag">
              <i class="fas fa-seedling"></i>
              {{ crop }}
            </span>
          </div>
        </div>
      </div>

      <div class="measurements-list">
        <h4>รายการจุดวัด (Measurement ID)</h4>
        <div *ngFor="let measurement of selectedArea.measurements" class="measurement-item">
          <div class="measurement-info">
            <div class="measurement-point">Measurement ID: {{ measurement['measurementid'] || measurement['id'] ||
              'ไม่ระบุ'
              }}</div>
            <div class="measurement-location">{{ measurement.location || 'ไม่ระบุตำแหน่ง' }}</div>
            <div class="measurement-date">{{ measurement.measurement_date || measurement.date || 'ไม่ระบุวันที่' }}
            </div>
            <div class="measurement-areasid">Areas ID: {{ measurement['areasid'] || 'ไม่ระบุ' }}</div>
          </div>
          <button class="view-detail-btn" (click)="viewMeasurementDetail(measurement)">ดูรายละเอียด</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CSS สำหรับการตกแต่งค่าเฉลี่ยการวัดใหม่ -->
<style>
  /* Main Measurement Cards Grid */
  .measurement-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .measurement-card {
    position: relative;
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    overflow: hidden;
  }

  .measurement-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  }

  .card-border {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    border-radius: 4px 0 0 4px;
  }

  .temperature-border {
    background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
  }

  .moisture-border {
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
  }

  .nitrogen-border {
    background: linear-gradient(135deg, #74b9ff, #0984e3);
  }

  .phosphorus-border {
    background: linear-gradient(135deg, #fdcb6e, #e17055);
  }

  .potassium-border {
    background: linear-gradient(135deg, #a29bfe, #6c5ce7);
  }

  .ph-border {
    background: linear-gradient(135deg, #fd79a8, #e84393);
  }

  .card-icon {
    text-align: center;
    margin-bottom: 15px;
  }

  .card-icon img {
    width: 48px;
    height: 48px;
    object-fit: contain;
  }

  .card-content {
    text-align: center;
  }

  .card-label {
    font-size: 14px;
    color: #6c757d;
    font-weight: 500;
    margin-bottom: 8px;
  }

  .card-value {
    font-size: 24px;
    font-weight: bold;
    color: #2d3436;
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Summary Results Panel */
  .summary-results-panel {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #dee2e6;
  }

  .panel-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #4ecdc4;
  }

  .panel-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
  }

  .panel-icon i {
    color: white;
    font-size: 18px;
  }

  .panel-header h5 {
    margin: 0;
    color: #495057;
    font-size: 18px;
    font-weight: 600;
  }

  .results-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
  }

  .result-item {
    background: white;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
  }

  .result-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .result-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
  }

  .result-icon i {
    font-size: 14px;
    color: white;
  }

  .temperature-icon {
    background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
  }

  .moisture-icon {
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
  }

  .ph-icon {
    background: linear-gradient(135deg, #fd79a8, #e84393);
  }

  .nitrogen-icon {
    background: linear-gradient(135deg, #74b9ff, #0984e3);
  }

  .phosphorus-icon {
    background: linear-gradient(135deg, #fdcb6e, #e17055);
  }

  .potassium-icon {
    background: linear-gradient(135deg, #a29bfe, #6c5ce7);
  }

  .result-label {
    font-size: 14px;
    color: #6c757d;
    font-weight: 500;
    flex: 1;
  }

  .result-value {
    font-size: 16px;
    font-weight: bold;
    color: #2d3436;
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .measurement-cards-grid {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .card-value {
      font-size: 20px;
    }

    .results-list {
      grid-template-columns: 1fr;
    }

    .result-item {
      flex-direction: column;
      text-align: center;
      gap: 10px;
    }

    .result-icon {
      margin-right: 0;
    }
  }

  @media (max-width: 480px) {
    .measurement-cards-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .card-value {
      font-size: 18px;
    }
  }

  /* Enhanced Map Instruction Bar */
  .map-instruction-bar {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid #e9ecef;
    border-radius: 12px;
    margin-top: 15px;
    padding: 0;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }

  .instruction-content {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    gap: 15px;
  }

  .instruction-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(78, 205, 196, 0.3);
  }

  .instruction-icon i {
    color: white;
    font-size: 16px;
  }

  .instruction-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .instruction-main {
    font-size: 16px;
    font-weight: 600;
    color: #2d3436;
    line-height: 1.4;
  }

  .instruction-sub {
    font-size: 13px;
    color: #636e72;
    font-weight: 400;
    opacity: 0.8;
  }

  .instruction-visual {
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }

  .marker-preview {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .preview-marker {
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    box-shadow: 0 2px 6px rgba(78, 205, 196, 0.4);
    position: relative;
  }

  .preview-marker::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(45deg);
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
  }

  .preview-label {
    font-size: 11px;
    color: #636e72;
    font-weight: 500;
    text-align: center;
  }

  /* Hover Effect */
  .map-instruction-bar:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .map-instruction-bar:hover .instruction-icon {
    box-shadow: 0 4px 12px rgba(78, 205, 196, 0.4);
  }

  .map-instruction-bar:hover .preview-marker {
    box-shadow: 0 3px 8px rgba(78, 205, 196, 0.5);
  }

  /* Responsive Design for Instruction Bar */
  @media (max-width: 768px) {
    .instruction-content {
      padding: 14px 16px;
      gap: 12px;
    }

    .instruction-icon {
      width: 36px;
      height: 36px;
    }

    .instruction-icon i {
      font-size: 14px;
    }

    .instruction-main {
      font-size: 15px;
    }

    .instruction-sub {
      font-size: 12px;
    }

    .preview-marker {
      width: 20px;
      height: 20px;
    }

    .preview-marker::after {
      width: 6px;
      height: 6px;
    }

    .preview-label {
      font-size: 10px;
    }
  }

  @media (max-width: 480px) {
    .instruction-content {
      flex-direction: column;
      text-align: center;
      gap: 10px;
    }

    .instruction-text {
      order: 1;
    }

    .instruction-visual {
      order: 2;
    }

    .instruction-icon {
      order: 3;
    }
  }
</style>