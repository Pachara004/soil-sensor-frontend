<div class="measure-container" (click)="closeCardMenu()">
  <!-- Back arrow ‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å card -->
  <i class="fas fa-arrow-left back" (click)="goBack()"></i>

  <!-- ‡∏à‡∏∏‡∏î 3 ‡∏à‡∏∏‡∏î‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å card -->
  <div class="card-menu" (click)="toggleCardMenu(); $event.stopPropagation()">
    <i class="fas fa-ellipsis-v"></i>
    <div class="menu-dropdown" *ngIf="showCardMenu" (click)="$event.stopPropagation()">
      <div class="menu-item" (click)="goToProfile(); closeCardMenu()">
        <i class="fas fa-user"></i>
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      </div>
      <div class="menu-item" (click)="goToContactAdmin(); closeCardMenu()">
        <i class="fas fa-user-shield"></i>
        ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      </div>
    </div>
  </div>

  <div class="card" (click)="$event.stopPropagation()">

    <div class="header">
      <div class="user-summary">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-details">
          <h3 class="user-name">{{ userName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</h3>
          <p class="user-email">{{ userEmail || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</p>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="subtitle">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏Ñ‡πà‡∏≤</div>
      <div class="device-box">
        <span>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</span>
        <select [(ngModel)]="deviceId" (ngModelChange)="onDeviceChange()">
          <option *ngFor="let device of devices" [value]="device">{{ device }}</option>
        </select>
      </div>
    </div>

    <div *ngIf="isLoading" class="loading">
      <mat-spinner></mat-spinner>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div *ngIf="!isLoading && !showAreaDetails" class="history-list">
      <div class="area-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î</div>
      <div *ngFor="let area of areaGroups" class="area-item">
        <div class="area-header">
          <h3 class="area-name">{{ getDisplayAreaName(area) }}</h3>
          <div class="area-info-row">
            <div class="area-info-item">
              <i class="fas fa-map-marker-alt"></i>
              <span class="info-label">‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î:</span>
              <span class="info-value">{{ area.totalMeasurements }} ‡∏à‡∏∏‡∏î</span>
              <span class="info-detail" *ngIf="area.totalMeasurements > 0">(Measurement ID: {{
                getMeasurementIdRange(area) }})</span>
            </div>
            <div class="area-info-item">
              <i class="fas fa-calendar-alt"></i>
              <span class="info-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
              <span class="info-value">{{ area.lastMeasurementDate | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>
        </div>
        <div class="area-averages">
          <div class="avg-grid">
            <div class="avg-item">
              <span class="avg-label">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</span>
              <span class="avg-value">{{ formatNumber(area.averages.temperature) }}¬∞C</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</span>
              <span class="avg-value">{{ formatNumber(area.averages.moisture) }}%</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">N</span>
              <span class="avg-value">{{ formatNumber(area.averages.nitrogen) }}</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">P</span>
              <span class="avg-value">{{ formatNumber(area.averages.phosphorus) }}</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">K</span>
              <span class="avg-value">{{ formatNumber(area.averages.potassium) }}</span>
            </div>
            <div class="avg-item">
              <span class="avg-label">pH</span>
              <span class="avg-value">{{ formatNumber(area.averages.ph, 1) }}</span>
            </div>
          </div>
        </div>
        <div class="area-actions">
          <button class="detail-btn" (click)="viewAreaDetails(area)">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
          <button class="stats-btn" (click)="showAreaStatistics(area)">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
          <button class="points-btn" (click)="viewAllMeasurementPoints(area)">‡∏î‡∏π‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
      </div>
      <div *ngIf="areaGroups.length === 0" class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏Ñ‡πà‡∏≤</div>
    </div>

    <div *ngIf="!isLoading && showAreaDetails && selectedArea" class="area-details-view">
      <!-- Header Section -->
      <div class="area-detail-header">
        <button class="back-to-list" (click)="backToAreaList()">
          <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö
        </button>
        <div class="area-title-section">
          <h3>{{ selectedArea.areaName }}</h3>
          <div class="area-info">
            <span class="area-date">{{ selectedArea.lastMeasurementDate | date:'dd/MM/yyyy' }}</span>
            <span class="area-points">{{ selectedArea.totalMeasurements }} ‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î</span>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <div class="area-summary">
        <h4>
          <i class="fas fa-map"></i>
          ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î
        </h4>
        <div id="mapContainer" style="height: 400px; width: 100%; border-radius: 12px; border: 2px solid #e0e0e0;">
        </div>
        <p style="text-align: center; margin-top: 10px; color: #666;">
          <i class="fas fa-info-circle"></i>
          ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏∏‡∏î
        </p>
      </div>

      <!-- Summary Statistics Section -->
      <div class="area-summary">
        <h4>
          <i class="fas fa-chart-line"></i>
          ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
        </h4>
        <div class="area-stats-grid">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î</div>
              <div class="stat-value">{{ selectedArea.totalMeasurements }} ‡∏à‡∏∏‡∏î</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
              <div class="stat-value">{{ selectedArea.lastMeasurementDate | date:'dd/MM/yyyy HH:mm' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Average Values Section -->
      <div class="area-summary">
        <h4>
          <i class="fas fa-calculator"></i>
          ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({{ selectedArea.totalMeasurements }} ‡∏à‡∏∏‡∏î)
        </h4>
        <div class="summary-grid">
          <div class="summary-item temperature">
            <div class="summary-icon">
              <i class="fas fa-thermometer-half"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.temperature) }}¬∞C</span>
            </div>
          </div>

          <div class="summary-item moisture">
            <div class="summary-icon">
              <i class="fas fa-tint"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.moisture) }}%</span>
            </div>
          </div>

          <div class="summary-item nitrogen">
            <div class="summary-icon">
              <i class="fas fa-atom"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô (N)</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.nitrogen) }} mg/kg</span>
            </div>
          </div>

          <div class="summary-item phosphorus">
            <div class="summary-icon">
              <i class="fas fa-circle"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">‡∏ü‡∏≠‡∏™‡∏ü‡∏≠‡∏£‡∏±‡∏™ (P)</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.phosphorus) }} mg/kg</span>
            </div>
          </div>

          <div class="summary-item potassium">
            <div class="summary-icon">
              <i class="fas fa-circle"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏° (K)</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.potassium) }} mg/kg</span>
            </div>
          </div>

          <div class="summary-item ph">
            <div class="summary-icon">
              <i class="fas fa-flask"></i>
            </div>
            <div class="summary-content">
              <span class="summary-label">‡∏Ñ‡πà‡∏≤ pH</span>
              <span class="summary-value">{{ formatNumber(selectedArea.averages.ph, 1) }}</span>
            </div>
          </div>

          <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ -->
          <div class="calculation-results" *ngIf="selectedArea.averages">
            <h4>üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h4>
            <div class="results-grid">
              <div class="result-item">
                <span class="result-label">üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span>
                <span class="result-value">{{ formatNumber(selectedArea.averages.temperature) }}¬∞C</span>
              </div>
              <div class="result-item">
                <span class="result-label">üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span>
                <span class="result-value">{{ formatNumber(selectedArea.averages.moisture) }}%</span>
              </div>
              <div class="result-item">
                <span class="result-label">üß™ pH ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span>
                <span class="result-value">{{ formatNumber(selectedArea.averages.ph, 1) }}</span>
              </div>
              <div class="result-item">
                <span class="result-label">üå± ‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span>
                <span class="result-value">{{ formatNumber(selectedArea.averages.nitrogen) }} mg/kg</span>
              </div>
              <div class="result-item">
                <span class="result-label">üî¨ ‡∏ü‡∏≠‡∏™‡∏ü‡∏≠‡∏£‡∏±‡∏™‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span>
                <span class="result-value">{{ formatNumber(selectedArea.averages.phosphorus) }} mg/kg</span>
              </div>
              <div class="result-item">
                <span class="result-label">‚ö° ‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span>
                <span class="result-value">{{ formatNumber(selectedArea.averages.potassium) }} mg/kg</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fertilizer Recommendation Section -->
      <div class="area-summary recommendation-section">
        <h4>
          <i class="fas fa-seedling"></i>
          ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πã‡∏¢
        </h4>
        <div class="recommendation-card">
          <div class="recommendation-header">
            <i class="fas fa-lightbulb"></i>
            <h5>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏¥‡∏ô</h5>
          </div>
          <p class="recommendation-text">{{ recommendSoilImprovement(selectedArea).message }}</p>
        </div>

        <div class="fertilizer-recommendations">
          <h5>
            <i class="fas fa-flask"></i>
            ‡∏™‡∏π‡∏ï‡∏£‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
          </h5>
          <div class="fertilizer-grid">
            <div *ngFor="let fertilizer of recommendSoilImprovement(selectedArea).fertilizers" class="fertilizer-card">
              <div class="fertilizer-icon">
                <i class="fas fa-pills"></i>
              </div>
              <div class="fertilizer-content">
                <h6>{{ fertilizer.formula }}</h6>
                <p class="fertilizer-amount">{{ fertilizer.amount }}</p>
                <p class="fertilizer-description">{{ fertilizer.description }}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="crop-recommendations">
          <h5>
            <i class="fas fa-leaf"></i>
            ‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ
          </h5>
          <div class="crop-tags">
            <span *ngFor="let crop of recommendCrops(selectedArea)" class="crop-tag">
              <i class="fas fa-seedling"></i>
              {{ crop }}
            </span>
          </div>
        </div>
      </div>

      <div class="measurements-list">
        <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î (Measurement ID)</h4>
        <div *ngFor="let measurement of selectedArea.measurements" class="measurement-item">
          <div class="measurement-info">
            <div class="measurement-point">Measurement ID: {{ measurement['measurementid'] || measurement['id'] ||
              '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
              }}</div>
            <div class="measurement-location">{{ measurement.location || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á' }}</div>
            <div class="measurement-date">{{ measurement.measurement_date || measurement.date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' }}
            </div>
            <div class="measurement-areasid">Areas ID: {{ measurement['areasid'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</div>
          </div>
          <button class="view-detail-btn" (click)="viewMeasurementDetail(measurement)">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ -->
<style>
  .calculation-results {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 1px solid #dee2e6;
  }

  .calculation-results h4 {
    color: #495057;
    margin-bottom: 15px;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    border-bottom: 2px solid #4ecdc4;
    padding-bottom: 10px;
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 12px;
  }

  .result-item {
    background: white;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
  }

  .result-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .result-label {
    font-size: 14px;
    color: #6c757d;
    font-weight: 500;
  }

  .result-value {
    font-size: 16px;
    font-weight: bold;
    color: #495057;
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .results-grid {
      grid-template-columns: 1fr;
    }

    .result-item {
      flex-direction: column;
      text-align: center;
      gap: 8px;
    }

    .result-label {
      font-size: 12px;
    }

    .result-value {
      font-size: 14px;
    }
  }
</style>