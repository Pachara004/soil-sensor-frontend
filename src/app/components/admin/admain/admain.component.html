<div class="admin-container">
  <!-- Header -->
  <div class="header">
    <div class="logo">
      <i class="fas fa-seedling"></i>
      <span>Admin Panel</span>
    </div>
    <button class="logout-btn" (click)="logout()">
      <i class="fas fa-sign-out-alt"></i>
      ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    </button>
  </div>

  <!-- Admin Info -->
  <div class="admin-info">
    <div class="admin-logo">
      <img src="https://cdn.iconscout.com/icon/premium/png-256-thumb/soil-sensor-4449978-3688706.png" alt="Soil Sensor"
        class="chip-icon">
      <div class="admin-title">Admin Panel</div>
    </div>
    <div class="admin-name">Admin : {{ adminName }}</div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <div class="action-btn" (click)="goToUsers()">
      <img src="https://www.iconpacks.net/icons/2/free-user-icon-3296-thumb.png" alt="Users">
      <div class="text">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
    </div>

    <div class="action-btn" (click)="goToReports()">
      <img src="https://cdn-icons-png.flaticon.com/512/565/565340.png" alt="Messages">
      <div class="text">
        ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        <span class="unread-count" *ngIf="unreadCount > 0">{{ unreadCount > 99 ? '99+' : unreadCount }}</span>
      </div>
    </div>
  </div>

  <!-- Stats Section -->
  <div class="stats-section">
    <div class="stats-card">
      <div class="stats-header">
        <span class="stats-icon">üë•</span>
        <div class="stats-title">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      </div>
      <div class="stats-content">
        <div class="stats-number">{{ totalUsers }}</div>
        <div class="stats-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
      </div>
      <div class="stats-action">
        <button class="view-all-btn" (click)="toggleUsersList()">
          {{ showUsersList ? '‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' }}
        </button>
      </div>
    </div>

    <div class="stats-card">
      <div class="stats-header">
        <span class="stats-icon">üì±</span>
        <div class="stats-title">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      </div>
      <div class="stats-content">
        <div class="stats-number">{{ devices.length }}</div>
        <div class="stats-label">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
      </div>
      <div class="stats-action">
        <button class="view-all-btn" (click)="toggleDevicesList()">
          {{ showDevicesList ? '‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Users Section -->
  <div class="content-section" *ngIf="showUsersList">
    <div class="section-header">
      <i class="fas fa-users"></i>
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({{ allUsersDisplay.length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
      <div class="header-actions">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ..." [(ngModel)]="userSearchQuery" (input)="onUserSearch()"
            class="search-input">
        </div>
        <button class="refresh-btn" (click)="loadAllUsersOnce()" [disabled]="loadingUsers">
          <i class="fas fa-sync-alt" [class.fa-spin]="loadingUsers"></i>
          <span *ngIf="!loadingUsers">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
          <span *ngIf="loadingUsers">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </button>
      </div>
    </div>
    <div class="content-list">
      <div class="user-card" *ngFor="let user of allUsersDisplay; let i = index">
        <div class="user-header">
          <div class="user-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="user-basic-info">
            <div class="user-name">{{ user.user_name || user.username || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</div>
            <div class="user-id">ID: {{ user.userid || user.id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</div>
          </div>
          <div class="user-role">
            <span class="role-badge" [ngClass]="'role-' + (user.role || user.type || 'user')">
              {{ user.role === 'admin' || user.type === 'admin' ? 'Admin' : 'User' }}
            </span>
          </div>
        </div>

        <div class="user-details">
          <div class="detail-row">
            <div class="detail-label">
              <i class="fas fa-envelope"></i>
              <span>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</span>
            </div>
            <div class="detail-value">{{ user.user_email || user.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</div>
          </div>

          <div class="detail-row" *ngIf="user.user_phone || user.phone">
            <div class="detail-label">
              <i class="fas fa-phone"></i>
              <span>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span>
            </div>
            <div class="detail-value">{{ user.user_phone || user.phone }}</div>
          </div>

          <div class="detail-row">
            <div class="detail-label">
              <i class="fas fa-calendar-plus"></i>
              <span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span>
            </div>
            <div class="detail-value">{{ formatDate(user.created_at || user.createdAt) }}</div>
          </div>

          <div class="detail-row" *ngIf="user.updated_at || user.updatedAt">
            <div class="detail-label">
              <i class="fas fa-calendar-check"></i>
              <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
            </div>
            <div class="detail-value">{{ formatDate(user.updated_at || user.updatedAt) }}</div>
          </div>

          <div class="detail-row" *ngIf="user.firebase_uid || user.firebaseUid">
            <div class="detail-label">
              <i class="fas fa-fire"></i>
              <span>Firebase UID:</span>
            </div>
            <div class="detail-value firebase-uid">{{ user.firebase_uid || user.firebaseUid }}</div>
          </div>
        </div>

        <div class="user-actions">
          <button class="btn btn-edit" (click)="editUser(user)" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <i class="fas fa-edit"></i>
            <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
          </button>
          <button class="btn btn-delete" (click)="deleteUser(user.user_name || user.username)" title="‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <i class="fas fa-trash"></i>
            <span>‡∏•‡∏ö</span>
          </button>
          <button class="btn btn-view" (click)="viewUserDetails(user)" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
            <i class="fas fa-eye"></i>
            <span>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
          </button>
        </div>
      </div>

      <div class="no-data" *ngIf="allUsersDisplay.length === 0 && !loadingUsers">
        <i class="fas fa-users"></i>
        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" *ngIf="showEditModal">
    <div class="modal">
      <div class="modal-header">
        <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
        <button class="close-btn" (click)="closeEditModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
          <input type="text" [(ngModel)]="editingUser.username" readonly>
        </div>
        <div class="form-group">
          <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
          <input type="email" [(ngModel)]="editingUser.email">
        </div>
        <div class="form-group">
          <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô):</label>
          <input type="password" [(ngModel)]="newPassword">
        </div>
        <div class="form-group">
          <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
          <select [(ngModel)]="editingUser.type">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="save-btn" (click)="saveUserChanges()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="cancel-btn" (click)="closeEditModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Pending Claims Section -->
  <div class="content-section" *ngIf="pendingClaims.length > 0">
    <div class="section-header">
      <i class="fas fa-clock"></i>
      <h3>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ú‡∏π‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
    </div>
    <div class="content-list">
      <div class="list-item" *ngFor="let c of pendingClaims">
        <div class="item-info">
          <div class="item-name">Device ID: {{ c.deviceId }}</div>
          <div class="item-detail">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: {{ c.username }}</div>
          <div class="item-detail">‡πÄ‡∏ß‡∏•‡∏≤: {{ c.ts | date:'short' }}</div>
        </div>
        <div class="item-actions">
          <button class="btn btn-edit" (click)="approveClaim(c.deviceId)">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          <button class="btn btn-delete" (click)="rejectClaim(c.deviceId)">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Devices Section -->
  <div class="content-section" *ngIf="showDevicesList">
    <div class="section-header">
      <i class="fas fa-microchip"></i>
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({{ devicesDisplay.length }} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</h3>
      <div class="header-actions">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå..." [(ngModel)]="deviceSearchQuery" (input)="onDeviceSearch()"
            class="search-input">
        </div>
        <button class="refresh-btn" (click)="loadDevices()" [disabled]="loadingDevices">
          <i class="fas fa-sync-alt" [class.fa-spin]="loadingDevices"></i>
          <span *ngIf="!loadingDevices">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
          <span *ngIf="loadingDevices">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </button>
      </div>
    </div>
    <div class="content-list">
      <div class="device-card" *ngFor="let device of devicesDisplay; let i = index">
        <div class="device-header">
          <div class="device-icon">
            <i class="fas fa-microchip"></i>
          </div>
          <div class="device-basic-info">
            <div class="device-name">{{ device.device_name || device.name || 'Device ' + (device.id || device.deviceid)
              }}</div>
            <div class="device-id">ID: {{ device.id || device.deviceid || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</div>
          </div>
          <div class="device-status">
            <span class="status-badge" [ngClass]="'status-' + (device.status || 'unknown')">
              {{ device.status === 'active' ? 'Active' : device.status === 'inactive' ? 'Inactive' : 'Unknown' }}
            </span>
          </div>
        </div>

        <div class="device-details">
          <div class="detail-row">
            <div class="detail-label">
              <i class="fas fa-microchip"></i>
              <span>Device ID:</span>
            </div>
            <div class="detail-value device-id-value">{{ device.id || device.deviceid || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</div>
          </div>

          <div class="detail-row" *ngIf="device.user_id || device.userid">
            <div class="detail-label">
              <i class="fas fa-user"></i>
              <span>User ID:</span>
            </div>
            <div class="detail-value user-id-value">{{ device.user_id || device.userid }}</div>
          </div>

          <div class="detail-row" *ngIf="device.user_id || device.userid">
            <div class="detail-label">
              <i class="fas fa-user-circle"></i>
              <span>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</span>
            </div>
            <div class="detail-value">{{ device.user_name || getDeviceUserName(device.user_id || device.userid) }}</div>
          </div>

          <div class="detail-row" *ngIf="device.user_email">
            <div class="detail-label">
              <i class="fas fa-envelope"></i>
              <span>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</span>
            </div>
            <div class="detail-value">{{ device.user_email }}</div>
          </div>

          <div class="detail-row">
            <div class="detail-label">
              <i class="fas fa-info-circle"></i>
              <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
            </div>
            <div class="detail-value">
              <span [ngClass]="device.status === 'active' ? 'status-active' : 'status-inactive'">
                {{ device.status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}
              </span>
            </div>
          </div>

          <div class="detail-row" *ngIf="device.created_at">
            <div class="detail-label">
              <i class="fas fa-calendar-plus"></i>
              <span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span>
            </div>
            <div class="detail-value">{{ formatDate(device.created_at) }}</div>
          </div>

          <div class="detail-row" *ngIf="device.updated_at">
            <div class="detail-label">
              <i class="fas fa-calendar-check"></i>
              <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
            </div>
            <div class="detail-value">{{ formatDate(device.updated_at) }}</div>
          </div>

          <div class="detail-row" *ngIf="device.description">
            <div class="detail-label">
              <i class="fas fa-align-left"></i>
              <span>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</span>
            </div>
            <div class="detail-value">{{ device.description }}</div>
          </div>
        </div>

        <div class="device-actions">
          <button class="btn btn-view" (click)="viewDevice(device)" title="‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå">
            <i class="fas fa-eye"></i>
            <span>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
          </button>
          <button class="btn btn-delete" (click)="deleteDevice(device.id || device.deviceid)" title="‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå">
            <i class="fas fa-trash"></i>
            <span>‡∏•‡∏ö</span>
          </button>
          <button class="btn btn-edit" (click)="editDevice(device)" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå">
            <i class="fas fa-edit"></i>
            <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
          </button>
        </div>
      </div>

      <div class="no-data" *ngIf="devicesDisplay.length === 0 && !loadingDevices">
        <i class="fas fa-microchip"></i>
        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p>
      </div>
    </div>
  </div>

  <!-- Add Device Section -->
  <div class="content-section">
    <div class="section-header">
      <i class="fas fa-plus-circle"></i>
      <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà</h3>
    </div>
    <div class="form-inputs">
      <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" [(ngModel)]="newDeviceName">
      <div class="user-input-box">
        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ..." [(ngModel)]="newDeviceUser" (input)="onUserInput()"
          (focus)="onUserInput()" (blur)="onInputBlur()" (keydown)="onKeyDown($event)" autocomplete="off">
        <div class="dropdown-container" *ngIf="filteredUsers.length > 0 && showDropdown">
          <div class="dropdown-header">
            <i class="fas fa-users"></i>
            <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ({{ filteredUsers.length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
          </div>
          <ul class="suggest-list">
            <li *ngFor="let u of filteredUsers; let i = index" (click)="selectUser(u.username)"
              [class.selected]="i === selectedIndex" (mouseenter)="selectedIndex = i">
              <div class="user-info">
                <div class="username">{{ u.username }}</div>
                <div class="email" *ngIf="u.email">{{ u.email }}</div>
                <div class="type" [ngClass]="'type-' + (u.type || 'user')">
                  {{ u.type === 'admin' ? 'Admin' : 'User' }}
                </div>
              </div>
            </li>
          </ul>
        </div>
        <div class="no-results" *ngIf="filteredUsers.length === 0 && newDeviceUser && showDropdown">
          <i class="fas fa-search"></i>
          <span>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö "{{ newDeviceUser }}"</span>
        </div>
      </div>
      <button class="save-btn" (click)="addDevice()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
    </div>
  </div>
</div>